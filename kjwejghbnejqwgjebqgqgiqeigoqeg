local player = game.Players.LocalPlayer
local character = player.Character or player.CharacterAdded:Wait()
local hrp = character:WaitForChild("HumanoidRootPart")
local cratesFolder = workspace:WaitForChild("xWorkspace"):WaitForChild("CRATES")

local enabled = true

local screenGui = Instance.new("ScreenGui")
screenGui.Name = "CrateFarmUI"
screenGui.ResetOnSpawn = false
screenGui.Parent = player:WaitForChild("PlayerGui")

local frame = Instance.new("Frame")
frame.Size = UDim2.new(0, 120, 0, 40)
frame.Position = UDim2.new(0.5, -60, 0.1, 0)
frame.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
frame.BorderSizePixel = 0
frame.Parent = screenGui

local corner = Instance.new("UICorner")
corner.CornerRadius = UDim.new(0, 8)
corner.Parent = frame

local button = Instance.new("TextButton")
button.Size = UDim2.new(1, -10, 1, -10)
button.Position = UDim2.new(0, 5, 0, 5)
button.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
button.Text = "ON"
button.TextColor3 = Color3.fromRGB(255, 255, 255)
button.Font = Enum.Font.GothamBold
button.TextSize = 16
button.BorderSizePixel = 0
button.Parent = frame

local buttonCorner = Instance.new("UICorner")
buttonCorner.CornerRadius = UDim.new(0, 6)
buttonCorner.Parent = button

local function updateButton()
    if enabled then
        button.BackgroundColor3 = Color3.fromRGB(0, 180, 0)
        button.Text = "ON"
    else
        button.BackgroundColor3 = Color3.fromRGB(180, 0, 0)
        button.Text = "OFF"
    end
end

button.MouseButton1Click:Connect(function()
    enabled = not enabled
    updateButton()
    print("Auto Farm:", enabled and "Ativado" or "Desativado")
end)

local dragging = false
local dragStart = nil
local startPos = nil

frame.InputBegan:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = true
        dragStart = input.Position
        startPos = frame.Position
    end
end)

frame.InputEnded:Connect(function(input)
    if input.UserInputType == Enum.UserInputType.MouseButton1 then
        dragging = false
    end
end)

game:GetService("UserInputService").InputChanged:Connect(function(input)
    if dragging and input.UserInputType == Enum.UserInputType.MouseMovement then
        local delta = input.Position - dragStart
        frame.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end
end)

player.CharacterAdded:Connect(function(char)
    character = char
    hrp = char:WaitForChild("HumanoidRootPart")
end)

local function safeWait(t)
    task.wait(t or 0.25)
end

local function safeTeleport(cf)
    if hrp then
        hrp.CFrame = cf
    end
end

local function activatePrompt(prompt)
    local part = prompt.Parent
    if part and part:IsA("BasePart") then
        print("Ativando prompt:", prompt:GetFullName())
        safeTeleport(part.CFrame + Vector3.new(0, 3, 0))
        safeWait(0.2)
        fireproximityprompt(prompt)
        safeWait(0.2)
    end
end

local function scanCrate(crate)
    if not enabled then return end
    print("Procurando prompts na crate:", crate.Name)
    for _, obj in ipairs(crate:GetDescendants()) do
        if obj:IsA("ProximityPrompt") then
            print("Prompt encontrado:", obj:GetFullName())
            activatePrompt(obj)
        end
    end
end

while task.wait(1) do
    if enabled then
        print("Procurando crates...")
        for _, crate in ipairs(cratesFolder:GetChildren()) do
            if not enabled then break end
            scanCrate(crate)
        end
    end
end
